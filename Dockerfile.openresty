ARG RESTY_IMAGE_BASE="ubuntu"
ARG RESTY_IMAGE_TAG="xenial"

FROM kong:${RESTY_IMAGE_BASE}-${RESTY_IMAGE_TAG}

ARG KONG_NETTLE_VERSION="3.4"
ARG KONG_GMP_VERSION="6.1.2"
ARG RESTY_VERSION="1.13.6.2"
ARG RESTY_LUAROCKS_VERSION="2.4.3"
ARG RESTY_OPENSSL_VERSION="1.0.2p"
ARG RESTY_PCRE_VERSION="8.41"
ARG RESTY_J="1"
ARG RESTY_CONFIG_OPTIONS="\
    --with-pcre-jit \
    --with-http_realip_module \
    --with-http_ssl_module \
    --with-http_stub_status_module \
    --with-http_v2_module \
    "
ARG RESTY_CONFIG_OPTIONS_MORE=""

LABEL resty_version="${RESTY_VERSION}"
LABEL resty_luarocks_version="${RESTY_LUAROCKS_VERSION}"
LABEL resty_openssl_version="${RESTY_OPENSSL_VERSION}"
LABEL resty_pcre_version="${RESTY_PCRE_VERSION}"
LABEL resty_config_options="${RESTY_CONFIG_OPTIONS}"
LABEL resty_config_options_more="${RESTY_CONFIG_OPTIONS_MORE}"

# These are not intended to be user-specified
ARG _RESTY_CONFIG_DEPS="--with-openssl=/tmp/openssl-${RESTY_OPENSSL_VERSION} --with-pcre=/tmp/pcre-${RESTY_PCRE_VERSION}"

RUN cd /tmp \
    && curl -fSL https://www.openssl.org/source/openssl-${RESTY_OPENSSL_VERSION}.tar.gz -o openssl-${RESTY_OPENSSL_VERSION}.tar.gz \
    && tar xzf openssl-${RESTY_OPENSSL_VERSION}.tar.gz \
    && curl -fSL https://ftp.pcre.org/pub/pcre/pcre-${RESTY_PCRE_VERSION}.tar.gz -o pcre-${RESTY_PCRE_VERSION}.tar.gz \
    && tar xzf pcre-${RESTY_PCRE_VERSION}.tar.gz \
    && curl -fSL https://openresty.org/download/openresty-${RESTY_VERSION}.tar.gz -o openresty-${RESTY_VERSION}.tar.gz \
    && tar xzf openresty-${RESTY_VERSION}.tar.gz \
    && curl -fSL https://github.com/luarocks/luarocks/archive/${RESTY_LUAROCKS_VERSION}.tar.gz -o luarocks-${RESTY_LUAROCKS_VERSION}.tar.gz \
    && tar xzf luarocks-${RESTY_LUAROCKS_VERSION}.tar.gz \
    && curl -fSL https://ftp.gnu.org/gnu/gmp/gmp-${KONG_GMP_VERSION}.tar.bz2 -o gmp-${KONG_GMP_VERSION}.tar.bz2 \
    && tar xjf gmp-${KONG_GMP_VERSION}.tar.bz2 \
    && curl -fSL https://ftp.gnu.org/gnu/nettle/nettle-${KONG_NETTLE_VERSION}.tar.gz -o nettle-${KONG_NETTLE_VERSION}.tar.gz \
    && tar xzf nettle-${KONG_NETTLE_VERSION}.tar.gz

RUN cd /tmp \
    && curl -fSL https://github.com/Kong/openresty-patches/archive/master.tar.gz -o kong-patches.tar.gz \
    && tar -xzf kong-patches.tar.gz -C /tmp \
    && cd /tmp/openresty-${RESTY_VERSION}/bundle/ \
    && for i in /tmp/openresty-patches-master/patches/1.13.6.2/*.patch; do patch -p1 < $i; done

RUN cd /tmp/openresty-${RESTY_VERSION} \
    && ./configure -j${RESTY_J} ${_RESTY_CONFIG_DEPS} ${RESTY_CONFIG_OPTIONS} ${RESTY_CONFIG_OPTIONS_MORE} \
    && make -j${RESTY_J} \
    && make -j${RESTY_J} install DESTDIR=/tmp/build

RUN cd /tmp/luarocks-${RESTY_LUAROCKS_VERSION} \
    && ./configure \
        --prefix=/tmp/build/usr/local \
        --with-lua=/tmp/build/usr/local/openresty/luajit \
        --lua-suffix=jit-2.1.0-beta3 \
        --with-lua-include=/tmp/build/usr/local/openresty/luajit/include/luajit-2.1 \
    && make build \
    && make install

RUN cd /tmp/openssl-${RESTY_OPENSSL_VERSION} \
    && make clean \
    && ./config -fPIC \
    && make -j${RESTY_J}

RUN cd /tmp/gmp-${KONG_GMP_VERSION} \
    && ./configure \
        --build=x86_64-linux-gnu \
        --enable-static=no \
        --libdir=$BUILD/usr/local/kong/lib \
    && make -j${RESTY_J}

RUN cd /tmp/nettle-${KONG_NETTLE_VERSION} \
    && DFLAGS="-Wl,-rpath,/usr/local/kong/lib" \
        ./configure --disable-static \
        --libdir=$BUILD/usr/local/kong/lib \
        --with-include-path="$TMP/gmp-${KONG_DEP_GMP_VERSION}/" \
        --with-lib-path="$TMP/gmp-${KONG_DEP_GMP_VERSION}/.libs/" \
    && make -j${RESTY_J}